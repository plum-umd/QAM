\subsection{Behavioral Refinement and Equivalence} \label{sec:refinement}

Here, we define QAM trace refinement relations, where two QAM systems are equivalent if the same sequences of actions can be performed
from their respective initial states.
Based on \Cref{def:labeledsystem},
given a rule $C_1 \xrightarrow{\alpha} C_2$ from a QAM system $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$ and an initial configuration $C$,
evaluating a step on $C$ is a transition relation $C \xrightarrow{\sigma(\alpha)} \sigma(C_2)$, where $\sigma$ is a substitution generated from pattern matching $C$ with respect $C_1$.
We also refer to $C \longrightarrow^* C'$ as configuration $C$ transitioning to $C'$, based on the rules in $\Cs$, via several internal steps.

\begin{definition}\label{def:traces}\rm[QAM Traces]
Given a QAM system $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$, traces of a configuration $C$ on the tuple is defined as an inductive set $\Tts(\Cs,C)$ of label sequences as:

\begin{itemize}
\item If $C \longrightarrow^* C'$ and $C'$ is stuck, $\Tts(\Cs,C)=\emptyset$.
\item If $C \longrightarrow^* C' \xrightarrow{p.c.m} C''$ and $C'$ is stuck, $\Tts(\Cs,C)=(c.m)::\Tts(\Cs,C'')$, i.e., $(c.m)::\Tts(\Cs,C'')$ is a new set that for all sequence $\xi \in \Tts(\Cs,C'')$, $(c.m)::\xi \in (c.m)::\Tts(\Cs,C'')$ and $::$ is a sequence concatenation operation.
\end{itemize}
\end{definition}

With the trace definition above, we can then define a trace refinement relation between two different QAM systems with tuples $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$ and $\Cs=(\Ms',\Ls',\Ts',\overline{\rules'})$, as well as initial configurations $C$ and $C'$.

\begin{definition}\label{def:traceeq}\rm[QAM Trace Refinement]
Given two QAM systems $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$ and $\Cs=(\Ms',\Ls',\Ts',\overline{\rules'})$, and initial configurations $C$ and $C'$,  we say that $(\Cs,C)$ trace refines $(\Cs',C')$, written as $(\Cs,C) \sqsubseteq (\Cs',C')$, iff $\Tts(\Cs,C)\subseteq \Tts(\Cs',C')$.

\end{definition}

Sometimes, in dealing with quantum protocol evaluation, we want to know if every step of transition in a QAM system has higher success rate than the other system. In such case, we first define probability traces in QAM below.

\begin{definition}\label{def:ptraces}\rm[QAM Probability Traces]
Given a QAM system $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$, traces of a configuration $C$ on the tuple is defined as an inductive set $\Pts(\Cs,C)$ of label sequences as:

\begin{itemize}
\item If $C \longrightarrow^* C'$ and $C'$ is stuck, $\Pts(\Cs,C)=\emptyset$.
\item If $C \longrightarrow^* C' \xrightarrow{p.c.m} C''$ and $C'$ is stuck, $\Pts(\Cs,C)=(c.m)^p::\Pts(\Cs,C'')$, i.e., $(c.m)^p::\Pts(\Cs,C'')$ is a new set that for all sequence $\xi \in \Pts(\Cs,C'')$, $(c.m)^p::\xi \in (c.m)^p::\Pts(\Cs,C'')$ and $::$ is a sequence concatenation operation.
\end{itemize}
\end{definition}

We can then define the probability subset relation between two trace sets and the probability trace refinement below.

\begin{definition}\label{def:ptracesub}\rm[QAM Probability Trace Subset]
Given two probability trace sets $S$ and $S'$, $S \subseteq^p S'$ iff, for all $\xi \in S$, there is $\xi' \in S'$, such that for every $i$-th position in $\xi$ and $\xi'$, $\xi[i]=(c.m)^p$ and $\xi'[i]=(c.m)^{p'}$ and $p \le p'$.

\end{definition}

\begin{definition}\label{def:ptracerefine}\rm[QAM Probability Trace Refinment]
Given two QAM systems $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$ and $\Cs=(\Ms',\Ls',\Ts',\overline{\rules'})$, and initial configurations $C$ and $C'$,  we say that $(\Cs,C)$ probabilistically trace refines $(\Cs',C')$, written as $(\Cs,C) \sqsubseteq^p (\Cs',C')$, iff $\Pts(\Cs,C)\subseteq^p \Pts(\Cs',C')$.

\end{definition}




