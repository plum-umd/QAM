\section{Behavioral Refinement and Equivalence} \label{sec:refinement}

Here, we define QAM trace refinement relations, where two QAM systems are equivalent if the same sequences of actions can be performed
from their respective initial states.
Essentially, a QAM system $(\Ms,\Ls,\Ts,C,\overline{\rules})$
can be viewed as a tuple of four fixed sets $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$
and a configuration $C$ representing the initial program state.
Each rule in $\overline{\rules}$ is a label transition relation $C_1 \xrightarrow{\alpha} C_2$,
where $C_1$ and $C_2$ are configurations representing the states
before and after the rule application, and $\alpha$ is either empty or $p.c.m$.
If we collect the free metavariables ($\cn{FV}(-)$) appearing in a configuration and rule, 
the initial configuration $C$ is a \textit{ground term} without any metavariables ($\cn{FV}(C)=\emptyset$);
while $\cn{FV}(\alpha) \cup \cn{FV}(C_2)\subseteq \cn{FV}(C_1)$ for every rule, which is the well-formedness assumption for a QAM system.
We can define the transitions in a QAM system as follows:

\begin{definition}\label{def:labeledsystem}\rm[One QAM Transition Step]
Given a QAM system tuple $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$ and a ground term initial configuration $C$, there is a rule $C_1 \xrightarrow{\alpha} C_2 \in \overline{\rules}$, and one step transition by applying this rule is given as:
\begin{itemize}
\item There is a substitution $\sigma$ mapping every metavariable in $C_1$ to a term, such that $\sigma(C_1)=C$, where we substitute metavariables $x$ in $C_1$ with the mapped terms as $\sigma(x)$.
\item The result label and configuration by applying the rule is $\sigma(\alpha)$ and $\sigma(C_2)$.
\end{itemize}
\end{definition}

Based on the transition step definition, we define QAM traces as an inductive set below. Given a QAM system tuple $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$, a ground term configuration $C$ is \textit{stuck}, if and only if no rules in $\overline{\rules}$ can be applied on $C$ for a transition step. We also refer to $C \longrightarrow^* C'$ as configuration $C$ transitioning to $C'$, based on the rules in $\Cs$, via several internal steps (steps having no labels).

\begin{definition}\label{def:traces}\rm[QAM Traces]
Given a QAM system tuple $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$, traces of a configuration $C$ on the tuple is defined as an inductive set $\Tts(\Cs,C)$ of label sequences as:

\begin{itemize}
\item If $C \longrightarrow^* C'$ and $C'$ is stuck, $\Tts(\Cs,C)=\emptyset$.
\item If $C \longrightarrow^* C' \xrightarrow{p.c.m} C''$ and $C'$ is stuck, $\Tts(\Cs,C)=(c.m)::\Tts(\Cs,C'')$, i.e., $(c.m)::\Tts(\Cs,C'')$ is a new set that for all sequence $\xi \in \Tts(\Cs,C'')$, $(c.m)::\xi \in (c.m)::\Tts(\Cs,C'')$ and $::$ is a sequence concatenation operation.
\end{itemize}
\end{definition}

With the trace definition above, we can then define a trace refinement relation between two different QAM systems with tuples $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$ and $\Cs=(\Ms',\Ls',\Ts',\overline{\rules'})$, as well as initial configurations $C$ and $C'$.

\begin{definition}\label{def:traceeq}\rm[QAM Trace Refinement]
Given two QAM system tuples $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$ and $\Cs=(\Ms',\Ls',\Ts',\overline{\rules'})$, and initial configurations $C$ and $C'$,  we say that $(\Cs,C)$ trace refines $(\Cs',C')$, written as $(\Cs,C) \sqsubseteq (\Cs',C')$, iff $\Tts(\Cs,C)\subseteq \Tts(\Cs',C')$.

\end{definition}

Sometimes, in dealing with quantum protocol evaluation, we want to know if every step of transition in a QAM system has higher success rate than the other system. In such case, we first define probability traces in QAM below.

\begin{definition}\label{def:ptraces}\rm[QAM Probability Traces]
Given a QAM system tuple $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$, traces of a configuration $C$ on the tuple is defined as an inductive set $\Pts(\Cs,C)$ of label sequences as:

\begin{itemize}
\item If $C \longrightarrow^* C'$ and $C'$ is stuck, $\Pts(\Cs,C)=\emptyset$.
\item If $C \longrightarrow^* C' \xrightarrow{p.c.m} C''$ and $C'$ is stuck, $\Pts(\Cs,C)=(c.m)^p::\Pts(\Cs,C'')$, i.e., $(c.m)^p::\Pts(\Cs,C'')$ is a new set that for all sequence $\xi \in \Pts(\Cs,C'')$, $(c.m)^p::\xi \in (c.m)^p::\Pts(\Cs,C'')$ and $::$ is a sequence concatenation operation.
\end{itemize}
\end{definition}

We can then define the probability subset relation between two trace sets and the probability trace refinement below.

\begin{definition}\label{def:ptracesub}\rm[QAM Probability Trace Subset]
Given two probability trace sets $S$ and $S'$, $S \subseteq^p S'$ iff, for all $\xi \in S$, there is $\xi' \in S'$, such that for every $i$-th position in $\xi$ and $\xi'$, $\xi[i]=(c.m)^p$ and $\xi'[i]=(c.m)^{p'}$ and $p \le p'$.

\end{definition}

\begin{definition}\label{def:ptracerefine}\rm[QAM Probability Trace Refinment]
Given two QAM system tuples $\Cs=(\Ms,\Ls,\Ts,\overline{\rules})$ and $\Cs=(\Ms',\Ls',\Ts',\overline{\rules'})$, and initial configurations $C$ and $C'$,  we say that $(\Cs,C)$ probabilistically trace refines $(\Cs',C')$, written as $(\Cs,C) \sqsubseteq^p (\Cs',C')$, iff $\Pts(\Cs,C)\subseteq^p \Pts(\Cs',C')$.

\end{definition}




