\section{The Quantum Abstract Machine:  Syntax and Semantics} \label{sec:qam}

This section describes QAM's syntax and semantics through the QPass example \cite{10.1145/3387514.3405853}.

\begin{figure}[t]
{\small
\begin{center}
\begin{tikzpicture}[node distance={1cm}, thick, main/.style = {draw, circle}] 
\node[main] (1) {\cn{Ann}}; 
\node[main] (2) [right of=1] {$r_1$};
\node[main] (3) [right of=2] {$r_4$};
\node[main] (4) [right of=3] {\cn{Bob}};
\node[main] (5) [above right=0.5cm and 1.5cm of 1] {$r_2$};
\node[main] (6) [right of=5] {$r_3$};
\node[main] (7) [below of=1] {\cn{Cat}};
\node[main] (8) [below of=3] {\cn{Dan}};
\draw[-] (1) --  (2);
\draw[-] (2) --  (3);
\draw[-] (3) --  (4);
\draw[-] (1) --  (5);
\draw[-] (5) --  (6);
\draw[-] (6) --  (3);
\draw[-] (7) --  (2);
\draw[-] (2) --  (8);
\end{tikzpicture}
\end{center}
}
\caption{QPass Example Path Connectivity}
  \label{fig:q-pi-example}
\end{figure}

\subsection{Capturing the Quantum Network Behaviors} \label{sec:qamexample}

As we mentioned in \Cref{sec:background}, all quantum network protocols are based on the physical procedures of quantum teleportation and quantum swap operations and their physical phenomena and mathematical semantics have been well studied.
On the other hand, building an evaluation framework for quantum network protocols does not require us to implement the complete physical procedure of individual operations; 
instead, we intend to capture the operational behaviors that affect the evaluation factors,
including the success rates and probabilities of sending messages and the required resources.
In fact, both quantum teleportation and swap can be summarized as a procedure to communicate a qubit between two parties with the cost of two qubits.

Here, we investigate the modeling of message transmission in QAM by the QPass protocol \cite{10.1145/3387514.3405853}.
\Cref{fig:q-pi-example} shows an example connectivity diagram such that party $\cn{Ann}$ and $\cn{Cat}$ send messages to $\cn{Bob}$ and $\cn{Dan}$, via the middle routers $r_1$ to $r_4$. There are two paths for \cn{Ann} to send to \cn{Bob} ($r_2 - r_4$ and $r_1 - r_4$), while there is only one path to send message from \cn{Cat} to \cn{Dan} ($r_1$). 

In QAM, sending a message $a$ is viewed as a sequence of transmissions of $a$'s ownership from a node to its adjacent node.
For example, assume that we want to send message $a$ from \cn{Cat} to \cn{Dan}.
We transmit $a$ from \cn{Cat} to $r_1$ and from $r_1$ to \cn{Dan}, 
each of which costs the two participated nodes one qubit each.
There is also a probability reduction in guaranteeing that $a$ to be delivered to \cn{Dan}:
the more ownership transmissions, the lower probability that $a$ is delivered.
For example, the success rate of the transmission from \cn{Cat} to $r_1$ and from $r_1$ to \cn{Dan} might be user defined probability values $p$ and $p'$, so the success rate to send a message from \cn{Cat} to \cn{Dan} is $p * p'$.
For simplicity, in the example in \Cref{fig:q-pi-example}, we assume that each station transmission reduces the success rate by $50\%$,
i.e., if a message is transmitted from $a$ to $r_1$, it has $50\%$ chance that the message is lost.

In QAM, sending a message can be viewed as a sequence of transitions as $\to^{*}\xrightarrow{a}$,
where we might first execute several internal communication ($\to^{*}$, referring to $\tau$ transitions in classical process algebra),
with a final external communication $\xrightarrow{a}$, meaning that two parties are communicated through a message $a$.
When running a QAM program, there might be different ways where it can transit, which forms different sequences of transmissions that represent different possible ways of communication. It is also possible that some sequences only contain the internal communication part without the final external communication, which represents failure tries that there are some bottlenecks preventing the communication moving forward, because we want to allow different parties send messages via the same network at the same time period; however, this might cause message transition bottlenecks due to limited resources in different nodes.

Since quantum qubit information has lifetime, it might cause a message $a$ to lost completely if we simply queue a message at a bottleneck location until enough resources are available. Most quantum network protocols have the mechanism to bypass the message sending to another route. For example, assume that \cn{Ann} and \cn{Cat}'s messages are transmitted to $r_1$ at the same time, and $r_1$ only has a qubit resource and decide to send \cn{Cat}'s message first. Thus, \cn{Ann}'s message is queued because $r_1$ has no more resource. Then, after the life time of the \cn{Ann}'s message ends, the message sending sequence is classified as a failure try that does not have an ending external communication. To successfully send both messages, we need \cn{Ann}'s message to be bypassed through the $r_2 - r_4$ route, so the bottleneck in node $r_1$ is resolved and both messages can be delivered on time.

In the next two sections, we introduce the modeling of quantum network protocols via QAM formally.

\begin{figure}[t]
{\small
  \[\begin{array}{llcl} 
      \texttt{Variable} & x,y \\
      \texttt{Probability} & p &\in &\Rs\\
      \texttt{Message} & m &\in& \mathbb{M}\\
    \texttt{Channel} & c &\in& \Ls\\
    \texttt{Time Stamp} & t &\in& \mathbb{T}\\
    \texttt{Label} & a &\in& \Ls \times \mathbb{M}\\
      \texttt{Singleton Action} & A & ::= & \qsend{p}{c}{m}^t \mid \qrev{c}{x} \\
      \texttt{Process} & P,Q & ::= & 0 \mid A.P \mid \parl{P}{Q} \mid \comp{P} \\
      \texttt{Relations} & R & \in & \Ls \times \Ls \times \Rs \\
      \texttt{Objects} & \Os \\
      \texttt{Custom Cell} & \varphi,\psi & ::= & \pcell{P}{n}{c} \mid \qcell{\Os}{c}\\
      \texttt{Configuration} & C & ::= & \varphi^* \qcell{R}{\cn{rel}} \qcell{t}{\cn{gt}}
                             \pcell{A}{t}{\cn{comm}} \qcell{\cn{bool}}{\cn{pred}} \psi^* \\
      \texttt{Rules} & \rules & ::= & C \longrightarrow C \\
      \texttt{Meta Function} & \Cs & ::= & \decl{\rules}{\Cs} \mid C\\
    \end{array}
  \]
}
\caption{Quantum Pi Syntax}
  \label{fig:q-pi-syntax}
\end{figure}


\subsection{Syntax} \label{sec:qamsyntax}

QAM describes multiparty communication behaviors,
whose syntax is similarity to the chemistry abstract machine \cite{BERRY1992217} and $\Pi$-calculus.
The message label that is used to communicate different parties has the form $c.m$, 
where $c$ refers to a communication channel, and $m$ is a message, possibly a quantum state.
Each single process action can be a message sending $\qsend{p}{c}{m}^t$, meaning that a message $m$ is sent through the channel $c$ with the success probability rate $p$ initialized at the time stamp $t$, and a message receipt $\qrev{c}{x}$, referring to that a message is received through the channel $c$ and represented as variable $x$.

To describe the behaviors of a network system, every QAM system comes with a configuration $C$
containing two different kinds of cells --- process and content cells.
A configuration might contain one or more process cells $\pcell{P}{n}{c}$, representing the execution maltreated process of a local node with name $c$, such as the $\cn{Ann}$ and $r_1$ nodes in \Cref{fig:q-pi-example},
and $n$ is the available qubit resource in the node.
A multi-threaded process $P$ is the program actions that node $c$ can perform, which has similar syntax as $\Pi$-calculus.
Each process might contain multiple threads competing for executions, which are separated by a parallel operation $\cn{|}$.
Each single thread is a sequence of singleton actions that ends at the unit process $0$,
and $\comp{P}$ is a replication process that repeatedly executes the process $P$, 
which is used for resending messages, explained in \Cref{sec:qamsemantics}.

In QAM, a parallel process of a message sending and receipt, $\parl{\qact{\qsend{p}{c}{m}^t}{P}}{\qact{\qrev{c}{x}}{Q}}$,
causes the process to transit to $\parl{P}{Q[m/x]}$, which is similar to the $\Pi$-calculus semantics.
On the other hand, a parallel of two message sending, $\parl{\qact{\qsend{p}{c}{m}^t}{P}}{\qsend{p'}{c'}{m'}^{t'}{P'}}$,
refers to that the two operations are competing to convey the message outside of the node, possibly to other destinations.

The content cells act as control units for storing environment information for executing a QAM system.
Users are able to define their own content cell by instantiating object types $\Os$ to different user-defined types.
In QAM, we require at least four kinds of content cells: 
1) $\qcell{R}{\cn{rel}}$ is a relation cell defining the probability value to send out one message from a node to the other;
2) $\qcell{t}{\cn{gt}}$ is a global clock cell storing the global time stamp;
3) $\pcell{A}{t}{\cn{comm}}$ is a communication cell storing the message about to communicate at time $t$;
and 4) $\qcell{\cn{bool}}{\cn{pred}}$ is a predicate cell 
determining if a message communication can happen ($\texttt{true}$ in the cell) or not ($\texttt{false}$ in the cell).

Defining protocol systems might require the extension of semantic rule set to include specific behaviors.
We provide a meta level rule declaration operation ($\decl{\rules}{\Cs}$), allowing users to declare a new rule $\rules$ used in the system $\Cs$. 

{\footnotesize
\[
\Cella{\qsend{1}{c}{m}^0}{10}{\cn{Cat}}\Cella{0}{10}{r_1}
\Cella{\qrev{c}{m}.0}{10}{\cn{Dan}} 
\qcell{\{(\cn{Cat},r_1,0.5), (r_1,\cn{Dan},0.5)\}}{\cn{rel}}
\pcell{\emptyset}{0}{\cn{comm}}
\qcell{\texttt{true}}{\cn{pred}}
\qcell{0}{\cn{gt}}
\]
}

As an example of the QAM syntax, the above configuration defines the initial program state for sending a message $c.m$ from $\cn{Cat}$ to $\cn{Dan}$ via the router $r_1$, as part of the communication in \Cref{fig:q-pi-example}. Initially, the relation cell stores the connectivity between \cn{Cat}, \cn{Dan}, and $r_1$, with the success rates. 
The global time is initialized as $0$ in the \cn{gt} cell, and the predicate cell has a fixed value $\texttt{true}$, meaning that no extra condition is applied to each communication.
The message ($\qsend{1}{c}{m}^0$) sent from \cn{Cat} has an initial probability value $1$ and the time stamp $0$, referring to the time that the message is guaranteed to send out.
Node $r_0$ acts as a intermediate router, so it only contains the unit process $0$, and \cn{Dan} is waiting on receiving a message ($\qrev{c}{m}.0$). 

\begin{figure}[t]
{\small
  \begin{mathpar}

   \inferrule[GenChan]{}
       {\Cellb{\qsend{p}{c}{m}^t}{i}{a}\Cella{P}{j}{b} \qcell{\{(a,b,p)\}\cup R}{\cn{rel}}\qcell{t'}{\cn{gt}}
        \longrightarrow \Cellb{}{i-}{a}\Cella{\qsend{p}{c}{m}^{t}\texttt{|}P}{j-}{b}
              \qcell{\{(a,b,p)\}\cup R}{\cn{rel}}\qcell{t'+}{\cn{gt}} }

\ignore{
   \inferrule[GenQubit]{}
       {\Cella{P}{n,t'}{a}\qcell{t}{\cn{gt}}\longrightarrow \Cella{P}{n+,t}{a}\qcell{t}{\cn{gt}}}\;\;\texttt{when}\;t \texttt{|} \beta\wedge t' < t
}

   \inferrule[MoreTries]{}
       {\comp{P} \longrightarrow \parl{P}{\comp{P}}}
      
   \inferrule[NoTries]{}
       {\comp{P} \longrightarrow 0}

  \inferrule[PreCom]{}
      { \Cellb{\qsend{p}{c}{m}^t\texttt{|} \qrev{c}{x}.P}{n}{c}\qcell{t'}{\cn{gt}}\pcell{\emptyset}{\_}{\cn{comm}}
           \longrightarrow
         \Cellb{P[m/x]}{n}{c}\qcell{t'+}{\cn{gt}}\pcell{\qsend{p}{c}{m}^t}{t'}{\cn{comm}}}
                  
  \inferrule[Com]{}
      { \pcell{\qsend{p}{c}{m}^t}{t'}{\cn{comm}}\qcell{\cn{true}}{\cn{pred}}
           \xrightarrow{p.c.m}  
         \pcell{\emptyset}{t'}{\cn{comm}}\qcell{\cn{true}}{\cn{pred}} } 

  \end{mathpar}
}
\caption{Quantum Pi Semantics. $\beta$, $\mu$, and $\nu$ are globally defined for the qubit generation period, the message threshold probability, and message sending finished threshold. $\Cella{P}{n}{a}$ refers to that the $t$ in $\Cella{P}{n,t}{a}$ is omitted in the rule.}
  \label{fig:q-pi-semantics}
\end{figure}

\ignore{
\begin{figure}[t]
{\small
{\hspace*{-2em}
\begin{tikzpicture}[align=center,node distance=1.5cm and -1cm, thick] 
\node (1) {S$\langle\{(a,r_1,0.5), (a,r_2,0.5)\}\cup$R$\rangle$}; 
\node (2) [below left= of 1] {$\Cella{0}{9}{a}$ $\Cella{\qsend{0.5}{c}{m}|0}{9}{r_1}$... $\langle\{(r_1,r_4)\}\cup$R$\rangle$}; 
\node (3) [below right= of 1] {\text{\ \ \ \ \ \ }$\Cella{0}{9}{a}$ $\Cella{\qsend{0.5}{c}{m}|0}{9}{r_2}$..., $\ccell{\{(r_2,r_3)\}\cup\text{R}}$}; 
\node (4) [below of=2] {$\Cella{0}{8}{r_1}$ $\Cella{\qsend{0.25}{c}{m}|0}{9}{r_4}$... $\langle\{(r_4,b)\}\cup$R$\rangle$};
\node (5) [below of=3] {\text{\ \ \ \ \ \ }$\Cella{0}{8}{r_2}$ $\Cella{\qsend{0.25}{c}{m}|0}{9}{r_3}$..., $\ccell{\{(r_3,r_4)\}\cup\text{R}}$};
\node (6) [below of=4] {$\Cella{0}{8}{r_4}$ $\Cella{\qsend{0.125}{c}{m}|\qrev{c}{m}.0}{9}{b}$... $\ccell{\text{R}}$};
\node (7) [below of=5] {\text{\ \ \ \ \ \ \ \ \;}$\Cella{0}{8}{r_3}$ $\Cella{\qsend{0.125}{c}{m}|0}{9}{r_4}$..., $\ccell{\{(r_4,b)\}\cup\text{R}}$};
\node (8) [below of=6] {$\Cella{0}{9}{b}$... $\ccell{\text{R}}$};
\node (9) [below of=7] {\text{\ \ \ \ \ \ \ \ }$\Cella{0}{8}{r_4}$ $\Cella{\qsend{0.0625}{c}{m}|\qrev{c}{m}.0}{9}{b}$..., $\ccell{\text{R}}$};
\node (10) [below of=9] {\text{\ \ \ \ \ \ }$\Cella{0}{n}{b}$... $\ccell{\text{R}}$};
\draw[->] (1) -- node[midway, above left] {} (2); 
\draw[->] (1) -- node[midway, above right] {} (3); 
\draw[->] (2) -- node[midway, right] {} (4); 
\draw[->] (4) -- node[midway, right] {} (6);
\draw[->] (6) -- node[midway, right] {$0.125.c.m$} (8); 
\draw[->] (3) -- node[midway, right] {} (5); 
\draw[->] (5) -- node[midway, right] {} (7); 
\draw[->] (7) -- node[midway, right] {} (9);
\draw[->] (9) -- node[midway, right] {$0.0625.c.m$}  (10); 
\end{tikzpicture} 
}
}
\caption{Quantum Machine Transitions for \Cref{fig:q-pi-example}}
  \label{fig:q-pi-example1}
\end{figure} 
}

\subsection{Semantics} \label{sec:qamsemantics}

The QAM semantics is given in terms of the definition of a QAM system,
which is a structure $(\Ms,\Ls,\Ts,C,\overline{\rules})$,
where $\Ms$ is a set of messages;
$\Ls$ is a set of channels containing at least $\cn{rel}$, $\cn{comm}$, $\cn{gt}$, and $\cn{pred}$;
$\Ts$ is a set of time stamps that forms a linear order ($<$) with $0$ being the minimum;
$C$ is the configuration containing different cells that represent the nodes with processes and environment for the system, at least containing cell $\cn{rel}$, $\cn{comm}$, $\cn{gt}$, and $\cn{pred}$, mentioned in \Cref{sec:qamsyntax};
and $\overline{\rules}$ is a set of rule for guiding how the configuration is transited, at least contain rules \rulelab{GenChan}, \rulelab{MoreTries}, \rulelab{NoTries}, \rulelab{PreCom}, and \rulelab{Com} in \Cref{fig:q-pi-semantics}. 

QAM is flexible enough to define most quantum network/security protocols 
through the ability to extend rules by the rule declaration operation in \Cref{fig:q-pi-syntax}.
Every rule set must contain the five rules listed in \Cref{fig:q-pi-semantics},
because they represent the universally sound facts about multiparty quantum communication. 
We first discuss these five rules through the example configuration at the end of \Cref{sec:qamsyntax}. 

Rule \rulelab{GenChan} definition the message transformation behavior of conveying a message from a node to another that might be an intermediate router node, with the consumption of a qubit in each of the parties and a slot time change happening in the global clock.
The $...$ operation in cell $a$ refers to that there might 
be other paralleled processes associated in the process cell, but we disregard them.
For example, the message $\qsend{1}{c}{m}^0$ in cell \cn{Cat} can be conveyed to the $r_1$ cell with the new probability $0.5$, meaning that only $50\%$ change this communication is guaranteed.
This can happen because there is a defined relation tuple $(\cn{Cat},r_1,0.5)$ in the relation cell $\cn{rel}$. During the process, the qubit resources in $\cn{Cat}$ and $r_1$ both reduce one, and the global clock is updated. 
The transited cell structure is as follows:

{\footnotesize
\[
\begin{array}{l}
\longrightarrow\;\;
\Cella{0}{9}{\cn{Cat}}\Cella{\qsend{0.5}{c}{m}^0}{9}{r_1}
\Cella{\qrev{c}{m}.0}{10}{\cn{Dan}} 
\qcell{\{(\cn{Cat},r_1,0.5), (r_1,\cn{Dan},0.5)\}}{\cn{rel}}
\pcell{\emptyset}{0}{\cn{comm}}
\qcell{\texttt{true}}{\cn{pred}}
\qcell{1}{\cn{gt}}
\\[0.2em]
\longrightarrow\;\;
\Cella{0}{9}{\cn{Cat}}\Cella{0}{8}{r_1}
\Cella{\parl{\qsend{0.25}{c}{m}^0}{\qrev{c}{m}.0}}{9}{\cn{Dan}} 
\qcell{\{(\cn{Cat},r_1,0.5), (r_1,\cn{Dan},0.5)\}}{\cn{rel}}
\pcell{\emptyset}{0}{\cn{comm}}
\qcell{\texttt{true}}{\cn{pred}}
\qcell{2}{\cn{gt}}
\end{array}
\]
}

It is worth noting that we associate the parallel process $\cn{|}$ with identity, associativity, and commutativity equational rules, 
such that $\parl{P}{0}=P$, $\parl{(\parl{P}{Q})}{Q'}=\parl{P}{(\parl{Q}{Q'})}$, and $\parl{P}{Q}=\parl{Q}{P}$.
In the above case, $\qsend{0.5}{c}{m}^0$ can be viewed as $\parl{\qsend{0.5}{c}{m}^0}{0}$.

Rules \rulelab{PreCom} and \rulelab{Com} define the behavior when a message is delivered to its destination.
Rule \rulelab{PreCom} is applicable if the sending operation is already in its destination cell, and being paralleled with a same-channel message receipt process $\qrev{c}{x}.P$. After applying the rule, the message is processed as $P[m/x]$, and we also move the message $\qsend{p}{c}{m}^t$ to the communication cell $\cn{comm}$ with the current time stamp $t'$, so further user-defined rules can be applied on the message. We will see an example shortly below to highlight some of these additional rules.
Rule \rulelab{Com} processes the delivered message $\qsend{p}{c}{m}^t$ by removing it from the $\cn{comm}$ cell if the predicate cell $\cn{pred}$ is $\texttt{true}$. The processing refers to making the message a transition label $p.c.m$ appearing in the transition,
so the message delivery is publicized. Other than applying rule \rulelab{Com}, all other rule applications are considered to be internal communications. 
We show an example transition of consecutively applying rules \rulelab{PreCom} and \rulelab{Com} below, based on the above configuration after the two \rulelab{GenChan} rule applications.
In the first rule application, the message is moved to the \cn{comm} cell with the current global time $2$,
and the second rule application removes the message from the cell with a publicized transition label $0.25.c,m$. 


{\footnotesize
\[
\begin{array}{l}
\longrightarrow\;\;
\Cella{0}{9}{\cn{Cat}}\Cella{0}{8}{r_1}
\Cella{0}{9}{\cn{Dan}} 
\qcell{\{(\cn{Cat},r_1,0.5), (r_1,\cn{Dan},0.5)\}}{\cn{rel}}
\pcell{\qsend{0.25}{c}{m}^0}{2}{\cn{comm}}
\qcell{\texttt{true}}{\cn{pred}}
\qcell{3}{\cn{gt}}
\\[0.2em]
\xrightarrow{0.25.c,m} \;\;
\Cella{0}{9}{\cn{Cat}}\Cella{0}{8}{r_1}
\Cella{0}{9}{\cn{Dan}} 
\qcell{\{(\cn{Cat},r_1,0.5), (r_1,\cn{Dan},0.5)\}}{\cn{rel}}
\pcell{\emptyset}{2}{\cn{comm}}
\qcell{\texttt{true}}{\cn{pred}}
\qcell{3}{\cn{gt}}
\end{array}
\]
}

Rules \rulelab{MoreTries} and \rulelab{NoTries} define the behaviors of the replication $\comp{P}$.
The former suggests that a process can be replicated as many as we want, while the latter one refers to that a replication process can non-deterministically terminates.
In quantum communication, message deliveries are always associated with a success rate,
which indicates that users might be interested in repeatedly sending a message until some success rate assurance is guaranteed.
We will see an example success rate guarantee mechanism by using the replication operations with additional user-defined rules in \Cref{sec:case-study}.

\noindent\textbf{Extension of Rules.}
The rule set $\overline{\rules}$ is extendable by the user-defined rules, 
such that if a user declares the statement $\decl{\rules_1}{...\; \decl{\rules_n}{C_0}}$
in the QAM system $(\Ms,\Ls,\Ts,C,\overline{\rules})$, $C=C_0$ and $\overline{\rules}=\{\rules_1,...\rules_n,\rulelab{GenChan},\rulelab{MoreTries},\rulelab{NoTries}, \rulelab{PreCom},\rulelab{Com}\}$.

Permitting user-defined rules allows the definitions of different protocol guarantees in QAM,
which are useful in evaluating different performance merits of different protocols,
while rules in \Cref{fig:q-pi-semantics} establish the semantic basis of quantum network communication.
Here, we discuss how to guarantee the on-time message delivery in the QPass/QCast protocols,
which is a property that these protocols tried to guarantee but was not established formally in the previous work \cite{10.1145/3387514.3405853}.

The key observation in quantum network is that qubit messages have short life circles,
so the above quantum protocols developed complicated algorithms to guarantee the high delivery rates for quantum messages.
If a message is not delivered in time, its quantum state is cohered and information loses.

{\footnotesize
\[
\begin{array}{l}
\decl{\pcell{\qsend{p}{c}{m}^t}{t'}{\cn{comm}}\qcell{b}{\cn{pred}}\qcell{f}{\cn{tp}} 
     \longrightarrow \pcell{\qsend{p}{c}{m}^t}{t'}{\cn{comm}}\qcell{f(t,t')}{\cn{pred}}\qcell{f}{\cn{tp}}}{}
\\[0.2em]
\Cella{\qsend{1}{c}{m}^0}{10}{\cn{Cat}}\Cella{0}{10}{r_1}
\Cella{\qrev{c}{m}.0}{10}{\cn{Dan}} 
\qcell{\{(\cn{Cat},r_1,0.5), (r_1,\cn{Dan},0.5)\}}{\cn{rel}}
\pcell{\emptyset}{0}{\cn{comm}}
\qcell{\texttt{true}}{\cn{pred}}
\qcell{0}{\cn{gt}}
\qcell{\lambda\;(t,t')\,.\,t'-t<5}{\cn{tp}}
\end{array}
\]
}

To guarantee the property, we add a new cell $\cn{tp}$ and declare a new rule above (let's call it \rulelab{TP}).
Every time when a message is in the \cn{comm} cell, we apply the function $f$ in the new content cell \cn{tp} to the two time stamps $t$ and $t'$, and check if the message starting time $t$ and its delivery time $t'$ is within a threshold.
In the configuration, $\lambda\;(t,t')\,.\,t'-t<5$ is the lambda abstraction definition for $f$, as it takes two time stamps and checks if $t'-t$ is less than the threshold $5$.

After we declare rule \rulelab{TP} and new configuration, we essentially set up a new QAM system $(\Ms,\Ls,\Ts,C',\overline{\rules'})$,
where $C'$ is the new declared configuration and the rule set $\overline{\rules'}$ contains the five rules in \Cref{fig:q-pi-semantics} as well as rule \rulelab{TP}.
In the execution example above, after applying rule \rulelab{PreComm}, the \cn{comm} cell becomes $\pcell{\qsend{0.25}{c}{m}^0}{2}{\cn{comm}}$ with the starting time stamp $0$ and the delivery time stamp $2$.
By applying rule \rulelab{TP}, the expression $2-0 < 5$ results in \texttt{true}, which grants the message transition for the following \rulelab{Com} rule application. 
However, if we set the threshold to be $2$, such as having the function $\lambda\;(t,t')\,.\,t'-t<2$ in the \cn{tp} cell of the above configuration, the expression $2-0 < 2$ results in \texttt{false}, which means that the following \rulelab{Com} rule is not applicable.
The system might be stuck because there is no rule to empty the \cn{comm} cell, which can be classified as a failure due to the violation of the delivery time guarantee. 










