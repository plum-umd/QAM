\section{The Quantum Abstract Machine:  Syntax and Semantics} \label{sec:qam}

\begin{figure}[t]
{\small
  \[\begin{array}{llcl} 
      \texttt{Variable} & x,y \\
      \texttt{Probability} & p &\in &\Rs\\
      \texttt{Message} & m &\in& \mathbb{M}\\
    \texttt{Channel} & c &\in& \Ls\\
    \texttt{Time Stamp} & t &\in& \mathbb{T}\\
    \texttt{Label} & a &\in& \Ls \times \mathbb{M}\\
      \texttt{Singleton Action} & A & ::= & \qsend{p}{c}{m}^{t?} \mid \qrev{c}{x} \\
      \texttt{Process} & P,Q & ::= & 0 \mid A.P \mid \parl{P}{Q} \mid \comp{P} \\
      \texttt{Relations} & R & \in & \Ls \times \Ls \times \Rs \\
      \texttt{Predicate Action} & \alpha & ::= & \qsend{p}{c}{m}^t \mid (c,c,\qsend{p}{c}{m}^t) \\
      \texttt{Objects} & \Os \\
      \texttt{Custom Cell} & \varphi,\psi & ::= & \pcell{P}{n}{c} \mid \qcell{\Os}{c}\\
      \texttt{Configuration} & C & ::= & \varphi^* \qcell{R}{\cn{rel}} \qcell{t}{\cn{gt}}
                             \qcell{\alpha}{\cn{comm}} \pcell{\cn{bool}}{t}{\cn{pred}} \psi^* \\
      \texttt{Rules} & \rules & ::= & C \longrightarrow C \\
    \end{array}
  \]
}
\caption{Quantum Abstract Machine Syntax Table}
  \label{fig:q-pi-syntax}
\end{figure}

This section describes QAM's syntax and semantics,
whose design is based on two observations of different quantum network protocols, through an example connectivity diagram in \Cref{fig:q-pi-example}.

A QAM system is a structure $(\Ms,\Ls,\Ts,C,\overline{\rules})$,
where $\Ms$ is a set of messages;
$\Ls$ is a set of channels containing at least $\cn{rel}$, $\cn{comm}$, $\cn{gt}$, and $\cn{pred}$;
$\Ts$ is a set of time stamps that forms a linear order ($<$) with $0$ being the minimum;
$C$ is the configuration containing different cells that represent the nodes with processes and environment for the system, at least containing cell $\cn{rel}$, $\cn{comm}$, $\cn{gt}$, and $\cn{pred}$, mentioned in \Cref{sec:qamsyntax};
and $\overline{\rules}$ is a set of rule for guiding how the configuration is transited, at least contain rules \rulelab{CT},\rulelab{GC}, \rulelab{MT}, \rulelab{NT}, \rulelab{PC}, and \rulelab{Com} in \Cref{fig:q-pi-semantics}. 




\subsection{Syntax} \label{sec:qamsyntax}

QAM describes multiparty communication behaviors,
whose syntax is similarity to the chemistry abstract machine \cite{BERRY1992217} and $\Pi$-calculus.
The message label that is used to communicate different parties has the form $c.m$, 
where $c$ refers to a communication channel, and $m$ is a message, possibly a quantum state.
Each single process action can be a message sending $\qsend{p}{c}{m}^{t?}$, meaning that a message $m$ is sent through the channel $c$ with the success probability rate $p$ initialized at the time stamp $t$, and a message receipt $\qrev{c}{x}$, referring to that a message is received through the channel $c$ and represented as variable $x$.
The time stamp $t$ in a message sending operation can be omitted as $\qsend{p}{c}{m}$, meaning that the time stamp is generated when the message is sent out from its starting place.

To describe the behaviors of a network system, every QAM system comes with a configuration $C$
containing two different kinds of cells --- process and content cells.
A configuration might contain one or more process cells $\pcell{P}{n}{c}$, representing the execution maltreated process of a local node with name $c$, such as the $\cn{Ann}$ and $r_1$ nodes in \Cref{fig:q-pi-example},
and $n$ is the available qubit resource in the node.
A multi-threaded process $P$ is the program actions that node $c$ can perform, which has similar syntax as $\Pi$-calculus.
Each process might contain multiple threads competing for executions, which are separated by a parallel operation $\cn{|}$.
Each single thread is a sequence of singleton actions that ends at the unit process $0$,
and $\comp{P}$ is a replication process that repeatedly executes the process $P$, 
which is used for resending messages, explained in \Cref{sec:qamsemantics}.

In QAM, a parallel process of a message sending and receipt, $\parl{\qact{\qsend{p}{c}{m}^t}{P}}{\qact{\qrev{c}{x}}{Q}}$,
causes the process to transit to $\parl{P}{Q[m/x]}$, which is similar to the $\Pi$-calculus semantics.
On the other hand, a parallel of two message sending, $\parl{\qact{\qsend{p}{c}{m}^t}{P}}{\qsend{p'}{c'}{m'}^{t'}{P'}}$,
refers to that the two operations are competing to transmit the message outside of the node, possibly to other destinations.

The content cells act as control units for storing environment information for executing a QAM system.
Users are able to define their own content cell by instantiating object types $\Os$ to different user-defined types.
In QAM, we require at least four kinds of content cells: 
1) $\qcell{R}{\cn{rel}}$ is a relation cell defining the probability value to send out one message from a node to the other;
2) $\qcell{t}{\cn{gt}}$ is a global clock cell storing the global time stamp;
3) $\qcell{A}{\cn{comm}}$ is a communication cell storing the message about to communicate;
and 4) $\pcell{\cn{bool}}{t}{\cn{pred}}$ is a predicate cell 
determining if a message communication can happen ($\texttt{true}$ in the cell) or not ($\texttt{false}$ in the cell) at time $t$.

Defining protocol systems might require the extension of semantic rule set to include specific behaviors.
We provide a meta level rule declaration operation ($\decl{\rules}{\Cs}$), allowing users to declare a new rule $\rules$ used in the system $\Cs$. 

{\footnotesize
\[
\Cella{\qsend{1}{c}{m}}{10}{\cn{Cat}}\Cella{0}{10}{r_1}
\Cella{\qrev{c}{x}.0}{10}{\cn{Dan}} 
\qcell{\{(\cn{Cat},r_1,0.5), (r_1,\cn{Dan},0.5)\}}{\cn{rel}}
\qcell{\emptyset}{\cn{comm}}
\pcell{\texttt{false}}{0}{\cn{pred}}
\qcell{0}{\cn{gt}}
\]
}

As an example of the QAM syntax, the above configuration defines the initial program state for sending a message $c.m$ from $\cn{Cat}$ to $\cn{Dan}$ via the router $r_1$, as part of the communication in \Cref{fig:q-pi-example}. Initially, the relation cell stores the connectivity between \cn{Cat}, \cn{Dan}, and $r_1$, with the success rates. 
The global time is initialized as $0$ in the \cn{gt} cell, and the predicate cell has a fixed value $\texttt{false}$.
The message ($\qsend{1}{c}{m}$) sent from \cn{Cat} has an initial probability value $1$.
Node $r_0$ acts as a intermediate router, so it only contains the unit process $0$, and \cn{Dan} is waiting on receiving a message ($\qrev{c}{x}.0$). 

\begin{figure}[t]
{\small
  \begin{mathpar}
\mprset{flushleft}
   \inferrule[GC]{}
       {\Cellb{\qsend{p}{c}{m}^t}{i}{c_1}\Cella{P}{j}{c_2} \qcell{\{(c_1,c_2,p')\}\cup R}{\cn{rel}}\qcell{t'}{\cn{gt}}
        \qcell{\emptyset}{\cn{comm}}\pcell{b}{\_}{\cn{pred}}
       \\\\\qquad\qquad \longrightarrow \Cellb{}{i-}{c_1}\Cella{\qsend{p*p'}{c}{m}^{t}\texttt{|}P}{j-}{c_2}
              \qcell{\{(c_1,c_2,p')\}\cup R}{\cn{rel}}\qcell{t'}{\cn{gt}}
               \qcell{(c_1,c_2,\qsend{p}{c}{m}^t)}{\cn{comm}}\pcell{b}{t'}{\cn{pred}}}

\ignore{
   \inferrule[GenQubit]{}
       {\Cella{P}{n,t'}{a}\qcell{t}{\cn{gt}}\longrightarrow \Cella{P}{n+,t}{a}\qcell{t}{\cn{gt}}}\;\;\texttt{when}\;t \texttt{|} \beta\wedge t' < t
}

   \inferrule[CT]{}
       {\Cellb{\qsend{p}{c}{m}}{i}{c_1}\qcell{t}{\cn{gt}} \longrightarrow \Cellb{\qsend{p}{c}{m}^t}{i}{c_1}\qcell{t}{\cn{gt}}}

   \inferrule[MT]{}
       {\comp{P} \longrightarrow \parl{P}{\comp{P}}}
      
   \inferrule[NT]{}
       {\comp{P} \longrightarrow 0}

  \inferrule[PC]{}
      { \Cellb{\qsend{p}{c}{m}^t\texttt{|} \qrev{c}{x}.P}{n}{c}\qcell{t'}{\cn{gt}}\qcell{\emptyset}{\cn{comm}}\pcell{b}{\_}{\cn{pred}}
           \longrightarrow
         \Cellb{P[m/x]}{n}{c}\qcell{t'}{\cn{gt}}\qcell{\qsend{p}{c}{m}^t}{\cn{comm}}\pcell{b}{t'}{\cn{pred}}}
                  
  \inferrule[Com]{}
      { \qcell{t'}{\cn{gt}}\qcell{\qsend{p}{c}{m}^t}{\cn{comm}}\pcell{\cn{true}}{t'}{\cn{pred}}
           \xrightarrow{p.c.m}  
         \qcell{t'+}{\cn{gt}}\qcell{\emptyset}{\cn{comm}}\pcell{\cn{false}}{t'}{\cn{pred}} } 

  \inferrule[FC]{}
      { \qcell{t}{\cn{gt}}\qcell{(c_1,c_2,A)}{\cn{comm}}\pcell{\cn{true}}{t}{\cn{pred}}
           \longrightarrow
         \qcell{t+}{\cn{gt}}\qcell{\emptyset}{\cn{comm}}\pcell{\cn{false}}{t}{\cn{pred}} } 

  \end{mathpar}
}
\caption{Quantum Pi Semantics. $\beta$, $\mu$, and $\nu$ are globally defined for the qubit generation period, the message threshold probability, and message sending finished threshold. $\Cella{P}{n}{a}$ refers to that the $t$ in $\Cella{P}{n,t}{a}$ is omitted in the rule.}
  \label{fig:q-pi-semantics}
\end{figure}

\ignore{
\begin{figure}[t]
{\small
{\hspace*{-2em}
\begin{tikzpicture}[align=center,node distance=1.5cm and -1cm, thick] 
\node (1) {S$\langle\{(a,r_1,0.5), (a,r_2,0.5)\}\cup$R$\rangle$}; 
\node (2) [below left= of 1] {$\Cella{0}{9}{a}$ $\Cella{\qsend{0.5}{c}{m}|0}{9}{r_1}$... $\langle\{(r_1,r_4)\}\cup$R$\rangle$}; 
\node (3) [below right= of 1] {\text{\ \ \ \ \ \ }$\Cella{0}{9}{a}$ $\Cella{\qsend{0.5}{c}{m}|0}{9}{r_2}$..., $\ccell{\{(r_2,r_3)\}\cup\text{R}}$}; 
\node (4) [below of=2] {$\Cella{0}{8}{r_1}$ $\Cella{\qsend{0.25}{c}{m}|0}{9}{r_4}$... $\langle\{(r_4,b)\}\cup$R$\rangle$};
\node (5) [below of=3] {\text{\ \ \ \ \ \ }$\Cella{0}{8}{r_2}$ $\Cella{\qsend{0.25}{c}{m}|0}{9}{r_3}$..., $\ccell{\{(r_3,r_4)\}\cup\text{R}}$};
\node (6) [below of=4] {$\Cella{0}{8}{r_4}$ $\Cella{\qsend{0.125}{c}{m}|\qrev{c}{x}.0}{9}{b}$... $\ccell{\text{R}}$};
\node (7) [below of=5] {\text{\ \ \ \ \ \ \ \ \;}$\Cella{0}{8}{r_3}$ $\Cella{\qsend{0.125}{c}{m}|0}{9}{r_4}$..., $\ccell{\{(r_4,b)\}\cup\text{R}}$};
\node (8) [below of=6] {$\Cella{0}{9}{b}$... $\ccell{\text{R}}$};
\node (9) [below of=7] {\text{\ \ \ \ \ \ \ \ }$\Cella{0}{8}{r_4}$ $\Cella{\qsend{0.0625}{c}{m}|\qrev{c}{x}.0}{9}{b}$..., $\ccell{\text{R}}$};
\node (10) [below of=9] {\text{\ \ \ \ \ \ }$\Cella{0}{n}{b}$... $\ccell{\text{R}}$};
\draw[->] (1) -- node[midway, above left] {} (2); 
\draw[->] (1) -- node[midway, above right] {} (3); 
\draw[->] (2) -- node[midway, right] {} (4); 
\draw[->] (4) -- node[midway, right] {} (6);
\draw[->] (6) -- node[midway, right] {$0.125.c.m$} (8); 
\draw[->] (3) -- node[midway, right] {} (5); 
\draw[->] (5) -- node[midway, right] {} (7); 
\draw[->] (7) -- node[midway, right] {} (9);
\draw[->] (9) -- node[midway, right] {$0.0625.c.m$}  (10); 
\end{tikzpicture} 
}
}
\caption{Quantum Machine Transitions for \Cref{fig:q-pi-example}}
  \label{fig:q-pi-example1}
\end{figure} 
}

\begin{figure}[t]
{\small
\begin{center}
\begin{tikzpicture}[node distance={1cm}, thick, main/.style = {draw, circle}] 
\node[main] (1) {\cn{Ann}}; 
\node[main] (2) [right of=1] {$r_1$};
\node[main] (3) [right of=2] {$r_4$};
\node[main] (4) [right of=3] {\cn{Bob}};
\node[main] (5) [above right=0.5cm and 1.5cm of 1] {$r_2$};
\node[main] (6) [right of=5] {$r_3$};
\node[main] (7) [below of=1] {\cn{Cat}};
\node[main] (8) [below of=3] {\cn{Dan}};
\draw[-] (1) --  (2);
\draw[-] (2) --  (3);
\draw[-] (3) --  (4);
\draw[-] (1) --  (5);
\draw[-] (5) --  (6);
\draw[-] (6) --  (3);
\draw[-] (7) --  (2);
\draw[-] (2) --  (8);
\end{tikzpicture}
\end{center}
}
\caption{Example Path Connectivity}
  \label{fig:q-pi-example}
\end{figure}

\subsection{Semantics} \label{sec:qamsemantics}

The QAM semantics is given in terms of the definition of a QAM system,
which is a structure $(\Ms,\Ls,\Ts,C,\overline{\rules})$,
where $\Ms$ is a set of messages;
$\Ls$ is a set of channels containing at least $\cn{rel}$, $\cn{comm}$, $\cn{gt}$, and $\cn{pred}$;
$\Ts$ is a set of time stamps that forms a linear order ($<$) with $0$ being the minimum;
$C$ is the configuration containing different cells that represent the nodes with processes and environment for the system, at least containing cell $\cn{rel}$, $\cn{comm}$, $\cn{gt}$, and $\cn{pred}$, mentioned in \Cref{sec:qamsyntax};
and $\overline{\rules}$ is a set of rule for guiding how the configuration is transited, at least contain rules \rulelab{CT},\rulelab{GC}, \rulelab{MT}, \rulelab{NT}, \rulelab{PC}, and \rulelab{Com} in \Cref{fig:q-pi-semantics}. 

QAM is flexible enough to define most quantum network/security protocols 
through the ability to extend rules by the rule declaration operation in \Cref{fig:q-pi-syntax}.
Every rule set must contain the six rules listed in \Cref{fig:q-pi-semantics},
because they represent the universally sound facts about multiparty quantum communication. 
We first discuss these six rules through the example configuration at the end of \Cref{sec:qamsyntax}. 
For showing the consecutive transitions of a system, there must be additional rules for
granting every step of transition by turning the \cn{pred} cell's content to be \cn{true}.
Here, we first assume our example system includes the simplest granting rule by assigning \cn{true} to the \cn{pred} cell if the global time stamps in the \cn{gt} and \cn{pred} cells matched, as:

{\small
  \begin{mathpar}
   \inferrule[Grant]{}
       {\qcell{t}{\cn{gt}}\pcell{\cn{false}}{t}{\cn{pred}} \longrightarrow \qcell{t}{\cn{gt}}\pcell{\cn{true}}{t}{\cn{pred}}}
\end{mathpar}
}

In QAM, there are mainly two groups of rules, finishing the tasks of transmitting a message from a starting node to its destination via many middle routers and delivering the message in the destination.
Each group can be divided into a consecutive three kinds of rule applications: 1) we finish the major functionality of the task and move necessary information to the \cn{comm} and \cn{pred} cells for granting; 2) one or more granting rules are applied on the system to check if the task is finished correctly; and 3) we clean up the task information from the \cn{comm} and \cn{pred} cells and update the global clock to finalize the task execution.

In transmitting a message from a starting node to its destination,
we have the rule applications \rulelab{GC} and \rulelab{FC} for step (1) and (3) above, with some possible granting rules, such as rule \rulelab{Grant} above.
Rule \rulelab{GC} defines the message transmission behavior that might be an intermediate router node, with the consumption of a qubit in each of the parties and a slot time change happening in the global clock.
The $...$ operation in cell $a$ refers to that there might 
be other paralleled processes associated in the process cell, but we disregard them.
In rule \rulelab{GC}, it also moves the necessary information, such as the sender and receiver channel names as well as the message, in the \cn{comm} cell with the update of the time stamp $t'$ in the \cn{pred} cell to be the current global time,
indicating that at the current point, the system conveys a message from a node to another.
After an intermediate granting step, rule \rulelab{FC} is applied on a configuration to empty the \cn{comm} cell, initialize the \cn{pred} cell by putting an \cn{false} value, and increment the global clock.
Additionally, rule \rulelab{CT} generates a time stamp for a message that is about to send out.

{\footnotesize
\[
\begin{array}{ll}
\longrightarrow\;\;
\Cella{\qsend{1}{c}{m}^0}{10}{\cn{Cat}}\Cella{0}{10}{r_1}
\Cella{\qrev{c}{x}.0}{10}{\cn{Dan}} 
\qcell{\{(\cn{Cat},r_1,0.5), (r_1,\cn{Dan},0.5)\}}{\cn{rel}}
\qcell{\emptyset}{\cn{comm}}
\pcell{\texttt{false}}{0}{\cn{pred}}
\qcell{0}{\cn{gt}}
&
(\rulelab{CT})
\\[0.2em]
\longrightarrow\;\;
\Cella{0}{9}{\cn{Cat}}\Cella{A}{9}{r_1}
\Cella{\qrev{c}{x}.0}{10}{\cn{Dan}} 
\qcell{R}{\cn{rel}}
\qcell{(\cn{Cat},r_1,A)}{\cn{comm}}
\pcell{\texttt{false}}{0}{\cn{pred}}
\qcell{0}{\cn{gt}}
&
(\rulelab{GC})
\\[0.2em]
\longrightarrow\;\;
\Cella{0}{9}{\cn{Cat}}\Cella{A}{9}{r_1}
\Cella{\qrev{c}{x}.0}{10}{\cn{Dan}} 
\qcell{R}{\cn{rel}}
\qcell{(\cn{Cat},r_1,A)}{\cn{comm}}
\pcell{\texttt{true}}{0}{\cn{pred}}
\qcell{0}{\cn{gt}}
&
(\rulelab{Grant})
\\[0.2em]
\longrightarrow\;\;
\Cella{0}{9}{\cn{Cat}}\Cella{A}{9}{r_1}
\Cella{\qrev{c}{x}.0}{10}{\cn{Dan}} 
\qcell{R}{\cn{rel}}
\qcell{\emptyset}{\cn{comm}}
\pcell{\texttt{false}}{0}{\cn{pred}}
\qcell{1}{\cn{gt}}
&
(\rulelab{FC})
\\[0.2em]
\longrightarrow\;\;
\Cella{0}{9}{\cn{Cat}}\Cella{0}{8}{r_1}
\Cella{\parl{A'}{\qrev{c}{x}.0}}{9}{\cn{Dan}} 
\qcell{R}{\cn{rel}}
\qcell{(r_1,\cn{Dan},A')}{\cn{comm}}
\pcell{\texttt{false}}{1}{\cn{pred}}
\qcell{1}{\cn{gt}}
&
(\rulelab{GC})
\end{array}
\]
}
{\footnotesize
\begin{center}
$R\triangleq\{(\cn{Cat},r_1,0.5), (r_1,\cn{Dan},0.5)\}
\qquad
A\triangleq\qsend{0.5}{c}{m}^0
\qquad
A'\triangleq\qsend{0.25}{c}{m}^0$
\end{center}
}

The above transitions evolves the configuration in \Cref{sec:qamsyntax}. We first apply rule \rulelab{CT} to attach the current time $0$ to the message to send as $\qsend{1}{c}{m}^0$; then, apply rule \rulelab{GC}. The message $\qsend{1}{c}{m}^0$ in cell \cn{Cat} is transmitted to the $r_1$ cell with the new probability $0.5$, meaning that only $50\%$ change this communication is guaranteed.
This can happen because there is a defined relation tuple $(\cn{Cat},r_1,0.5)$ in the relation cell $\cn{rel}$. During the process, the qubit resources in $\cn{Cat}$ and $r_1$ both reduce one, and the global clock is updated. 
It is worth noting that 
we associate the parallel process $\cn{|}$ with identity, associativity, and commutativity equational rules, 
such that $\parl{P}{0}=P$, $\parl{(\parl{P}{Q})}{Q'}=\parl{P}{(\parl{Q}{Q'})}$, and $\parl{P}{Q}=\parl{Q}{P}$.
In the above case, $\qsend{0.5}{c}{m}^0$ can be viewed as $\parl{\qsend{0.5}{c}{m}^0}{0}$.
We then apply rule \rulelab{Grant} to put a \cn{true} value in the \cn{pred} cell and the \rulelab{FC} rule application cleans up the cells, so the transition of the message from node $r_1$ to \cn{Dan} can happen through the last \rulelab{GC} rule application.

{\footnotesize
\[
\begin{array}{lll}
&\Cella{0}{9}{\cn{Cat}}\Cella{0}{8}{r_1}
\Cella{\parl{A'}{\qrev{c}{x}.0}}{9}{\cn{Dan}} 
\qcell{R}{\cn{rel}}
\qcell{\emptyset}{\cn{comm}}
\pcell{\texttt{false}}{1}{\cn{pred}}
\qcell{2}{\cn{gt}}
\\[0.2em]
\longrightarrow
&
\Cella{0}{9}{\cn{Cat}}\Cella{0}{8}{r_1}
\Cella{0}{9}{\cn{Dan}} 
\qcell{R}{\cn{rel}}
\qcell{A'}{\cn{comm}}
\pcell{\texttt{false}}{2}{\cn{pred}}
\qcell{2}{\cn{gt}}
&
(\rulelab{PC})
\\[0.2em]
\longrightarrow
&
\Cella{0}{9}{\cn{Cat}}\Cella{0}{8}{r_1}
\Cella{0}{9}{\cn{Dan}} 
\qcell{R}{\cn{rel}}
\qcell{A'}{\cn{comm}}
\pcell{\texttt{true}}{2}{\cn{pred}}
\qcell{2}{\cn{gt}}
&
(\rulelab{Grant})
\\[0.2em]
\xrightarrow{0.25.c,m}
&
\Cella{0}{9}{\cn{Cat}}\Cella{0}{8}{r_1}
\Cella{0}{9}{\cn{Dan}} 
\qcell{R}{\cn{rel}}
\qcell{\emptyset}{\cn{comm}}
\pcell{\texttt{false}}{2}{\cn{pred}}
\qcell{3}{\cn{gt}}
&
(\rulelab{Com})
\end{array}
\]
}
{\footnotesize
\begin{center}
$R\triangleq\{(\cn{Cat},r_1,0.5), (r_1,\cn{Dan},0.5)\}
\qquad
A'\triangleq\qsend{0.25}{c}{m}^0$
\end{center}
}

For delivering a message in the destination,
rules \rulelab{PC} and \rulelab{Com} define the steps except the intermediate granting step.
Rule \rulelab{PC} is applicable if the sending operation is already in its destination cell, and being paralleled with a same-channel message receipt process $\qrev{c}{x}.P$. After applying the rule, the message is processed as $P[m/x]$, and we also move the message $\qsend{p}{c}{m}^t$ to the communication cell $\cn{comm}$ with the current time stamp $t'$, so further user-defined rules can be applied on the message.
The above example first provides an \rulelab{PC} rule application showing the exactly procedure above, i.e, the message is moved to the \cn{comm} cell with the current global time $2$.
After the granting step,
a \rulelab{Com} rule application processes the delivered message $\qsend{p}{c}{m}^t$ by removing it from the $\cn{comm}$ cell if the predicate cell $\cn{pred}$ is $\texttt{true}$. The processing refers to making the message a transition label $p.c.m$ appearing in the transition,
so the message delivery is publicized. Other than applying rule \rulelab{Com}, all other rule applications are considered to be internal communications. 
In the above example, the last \rulelab{Com} rule application removes the message from the cell with a publicized transition label $0.25.c,m$. 

Rules \rulelab{MT} and \rulelab{NT} define the behaviors of the replication $\comp{P}$.
The former suggests that a process can be replicated as many as we want, while the latter one refers to that a replication process can non-deterministically terminates.
In quantum communication, message deliveries are always associated with a success rate,
which indicates that users might be interested in repeatedly sending a message until some success rate assurance is guaranteed.
We will see an example success rate guarantee mechanism by using the replication operations with additional user-defined rules in \Cref{sec:add-prop}.

\noindent\textbf{Extension of Rules.}
The rule set $\overline{\rules}$ is extendable by user-defined rules, 
such that if a user declares the statement $\decl{\rules_1}{...\; \decl{\rules_n}{C_0}}$
in the QAM system $(\Ms,\Ls,\Ts,C,\overline{\rules})$, $C=C_0$ and $\overline{\rules}=\{\rules_1,...\rules_n,\rulelab{CT},\rulelab{GC},\rulelab{MT},\rulelab{NT}, \rulelab{PC},\rulelab{Com}\}$.

Permitting user-defined rules allows the definitions of different protocol guarantees in QAM,
which are useful in evaluating different performance merits of different protocols,
while rules in \Cref{fig:q-pi-semantics} establish the semantic basis of quantum network communication.
As the \rulelab{Grant} rule example above, the guarantees are established by evaluating different predicates in the \cn{pred} cell,
which we name granting steps in handling the tasks of conveying and delivering messages.
Here, we discuss how to guarantee the on-time message delivery in the QPass/QCast protocols \cite{10.1145/3387514.3405853},
which is a property that people tried to guarantee in these these protocols, but was not established formally \cite{10.1145/3387514.3405853}.

A key observation in quantum network is that qubit messages have short liftime,
so the above quantum protocols developed complicated algorithms to guarantee the high delivery rates for quantum messages.
If a message is not delivered in time, its quantum state is decohered and its information loses.

{\footnotesize
\[
\begin{array}{l}
\decl{\pcell{\qsend{p}{c}{m}^t}{t'}{\cn{comm}}\qcell{b}{\cn{pred}}\qcell{f}{\cn{tp}} 
     \longrightarrow \pcell{\qsend{p}{c}{m}^t}{t'}{\cn{comm}}\qcell{f(t,t')}{\cn{pred}}\qcell{f}{\cn{tp}}}{}
\\[0.2em]
\qquad
\Cella{\qsend{1}{c}{m}^0}{10}{\cn{Cat}}\Cella{0}{10}{r_1}
\Cella{\qrev{c}{x}.0}{10}{\cn{Dan}} 
\qcell{R}{\cn{rel}}
\pcell{\emptyset}{0}{\cn{comm}}
\qcell{\texttt{false}}{\cn{pred}}
\qcell{0}{\cn{gt}}
\qcell{\lambda\;(t,t')\,.\,t'-t<5}{\cn{tp}}
\end{array}
\]
}
{\footnotesize
\begin{center}
$R\triangleq\{(\cn{Cat},r_1,0.5), (r_1,\cn{Dan},0.5)\}$
\end{center}
}

To guarantee the property, we add a new cell $\cn{tp}$ and declare a new rule above (let's call it rule \rulelab{TP}).
Every time when an action is in the \cn{comm} cell, which we know rule \rulelab{PC} is applied prior to the state, we apply the function $f$ in the new content cell \cn{tp} to the two time stamps $t$ and $t'$, and check if the message starting time $t$ and its delivery time $t'$ is within a threshold.
In the configuration setting, function $f$ is defined as a lambda abstraction $\lambda\;(t,t')\,.\,t'-t<5$ and it takes two time stamps and checks if $t'-t$ is less than the threshold number $5$. In addition, we can rewrite the \rulelab{Grant} rule below to only grant transitions for conveying messages; in such case, the \cn{comm} cell contains a tuple $(c_1,c_2,A)$.  

{\small
  \begin{mathpar}
   \inferrule[Grant]{}
       {\qcell{t}{\cn{gt}}\qcell{(c_1,c_2,A)}{\cn{comm}}\pcell{\cn{false}}{t}{\cn{pred}} \longrightarrow \qcell{t}{\cn{gt}}\qcell{(c_1,c_2,A)}{\cn{comm}}\pcell{\cn{true}}{t}{\cn{pred}}}
\end{mathpar}
}

After we declare rule \rulelab{TP} and the new configuration, we essentially create a new QAM system $(\Ms,\Ls,\Ts,C',\overline{\rules'})$,
where $C'$ is the new declared configuration and the rule set $\overline{\rules'}$ contains the six rules in \Cref{fig:q-pi-semantics}, rule \rulelab{Grant} above, as well as rule \rulelab{TP}.
In the execution example above, after applying rule \rulelab{PC}, the \cn{comm} cell becomes $\pcell{\qsend{0.25}{c}{m}^0}{2}{\cn{comm}}$ with the starting time stamp $0$ and the delivery time stamp $2$.
By applying rule \rulelab{TP}, the expression $2-0 < 5$ results in \texttt{true}, which grants the message transition for the following \rulelab{Com} rule application. 
However, if we set the threshold to be $2$, such as having the function definition $\lambda\;(t,t')\,.\,t'-t<2$ in the \cn{tp} cell of the above configuration, the expression $2-0 < 2$ results in \texttt{false}, which means that the following \rulelab{Com} rule is not applicable.
The system might be stuck because there is no rule to empty the \cn{comm} cell, which can be classified as a failure due to the violation of the delivery time guarantee. 










